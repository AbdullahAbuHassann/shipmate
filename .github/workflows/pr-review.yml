name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  review:
    # Skip draft PRs and bot-authored PRs
    if: |
      github.event.pull_request.draft == false &&
      github.event.pull_request.user.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: "true"
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Perform a technical code review on this pull request.

            ## Review Philosophy

            - Simplicity is the ultimate sophistication — every line should justify its existence
            - Code is read far more often than it's written — optimise for readability
            - The best code is often the code you don't write
            - Elegance emerges from clarity of intent and economy of expression

            ## Steps

            1. Read CLAUDE.md and README.md to understand project standards and patterns.

            2. Get the PR diff and details:
               ```
               gh pr diff ${{ github.event.pull_request.number }}
               gh pr view ${{ github.event.pull_request.number }}
               ```

            3. Read each changed file in its entirety (not just the diff) to understand full context.

            4. For each changed file, analyse for:

               **Logic Errors**
               - Off-by-one errors, incorrect conditionals, missing error handling, race conditions

               **Security Issues**
               - SQL injection, XSS, insecure data handling, exposed secrets or API keys

               **Performance Problems**
               - N+1 queries, inefficient algorithms, memory leaks, unnecessary computations

               **Code Quality**
               - DRY violations, overly complex functions, poor naming, missing type hints

               **Adherence to Project Standards**
               - Standards documented in CLAUDE.md
               - Linting, typing, formatting, logging, and testing standards

            5. Verify issues are real before reporting — confirm type errors are legitimate, validate security concerns with context.

            ## Output

            - Use `mcp__github_inline_comment__create_inline_comment` for line-specific issues (file path, line number, comment).
            - Use `gh pr comment` for a top-level summary comment with overall findings, severity, and any issues that are not line-specific.
            - Be specific (line numbers, not vague complaints). Suggest fixes, don't just complain.
            - Flag security issues as CRITICAL.
            - If no issues found, post a short "Code review passed." comment.
            - Only post GitHub comments — do not output review text as messages.

          claude_args: |
            --model claude-sonnet-4-6
            --allowedTools "Read,Glob,Grep,Bash(git:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr comment:*),mcp__github_inline_comment__create_inline_comment"
